# Расчётно пояснительная записка сервиса для стриминга музыки

# 1 Тема и целевая аудитория

## 1.1 Описание и аналоги
### 1.1.1 Описание
Сервис для стриминга музыки – онлайн сервис, позволяющий пользователям слушать музыку в режиме реального времени, без скачивания треков к себе на устройство.
Сервис предоставляет систему рекомендаций, позволяющий найти пользователю треки, которые соответствуют его предпочтениям.

### 1.1.2 Существующие аналоги

В мире существует несколько аналогичных сервисов, среди них: Spotify, Яндекс Музыка, VK музыка.

## 1.2 Аудитория
### 1.2.1 Описание аудитории 

Основная аудитория – российские пользователи в возрасте от 16 до 50 лет, где на пользователей до 35 лет приходится не менее 60% охвата, как у аналогов сервиса, в соответсвии исследованием 2024 года [1](#список-источников)

### 1.2.2 Местоположение аудитории

Большая часть пользователей находится на территории Российской Федерации

### 1.2.3 Размер аудитрии

Согласно официальным финансовым отчётам Яндекса [2](#список-источников) аудитория сервиса стостовляет 30.5 миллионов человек, что будет являться основой в моём случае

## 1.3 Функциональные требования
### 1.3.1 Основной функционал

Функционал в целом схож с аналогами, например Яндекс музыкой [3](#список-источников). Среди него можно выделить:
 * Прослушивание музыки
 * Система рекомендаций, основанная на лайках, дизлайках и предпочтениях других пользователей
 * Добавление трека в "Сохранённое"
 * Формирование плейлиста
 * Проставление лайков и дизлайков
 * Просмотр плейлистов пользователей
 * Создание странички автора и загрузка собственных треков

### 1.3.2 Ключевые продуктовые решения

* Основный кейсом использования - прослушивание персонализированной подборки
* Создание плейлистов на основе прослушенных треков
* Возможность стать автором

### 1.3.3 Работа системы рекомендаций

Планируется использование коллаборативной фильтрации совместо HNSW алгоритмос (векторное расстояние). В HNSW вектор – набор заранее определённых тегов, которым трек соответствует или нет

## 1.4 Список источников

1. [Исследование аудитории стриминговых сервисов в России](https://adindex.ru/news/researches/2024/12/2/327867.phtml)
2. [Финансовый отчёт Яндекс за 3 квартал 2025 год](https://yastatic.net/s3/ir-docs/docs/2025/q3/25b90c11d0060d861ec0957dbbb96eeb/%D0%98%D0%BD%D1%84%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B0_3_%D0%BA%D0%B2_2025_060d.jpg)
3. [Документация Яндекс музыки](https://yandex.ru/support/music/ru/)


# 2 Расчёт нагрузки

## 2.1 Продуктовые метрики

| Метрика |  Значение  |                                  Комментарий |
| :------ | :--------: | -------------------------------------------: |
| MAU     |  30.5 млн  |                  Месячная активная аудитория |
| DAU     |  5.7 млн   |                   Дневная активная аудитория |
| SF      |   18.6 %   |                        Коэффициент липучести |
| СРХ     | 1211 строк |     Количество записей в БД для пользователя |
| СРХ     |   38 Кб    | Размер хранилища для отдельного пользователя |
| СКД     |     53     |     Среднее количество действий пользователя |

### 2.1.2 Расчёт MAU, DAU и SF

Статистика по ежемесячным и ежедневным активным пользователям бралась из активных источников [[1](#список-источников)] и [[2](#список-источников)].
Sticky Factor (коэффициент липучести) считался как:

$$
  SF=\frac{DAU}{MAU}
$$


### 2.1.3 Средний размер хранилища пользователя

Предполагается хранение истории прослушивания пользователя за последние 7 дней. Из исследования [[3](#список-источников)] получаем, что в среднем люди слушают 20.7 часов музыки в неделю.
В источнике [[4](#список-источников)] указано среднее время прослушивания для различныхх возрастных категорий. В нашем случае получаем среднее время прослушивания в соответсвии с ожидаемым распределением аудитории (расчёт в минутах):

$$
  \frac{3.51 + 3.7}{2} * 0.6 + 3.81 * 0.4 = 3.69
$$

Из расчёта, что за неделю у пользователя все треки уникальны, получаем:

$$
  \frac{20.7 * 60}{3.69} = 336
$$

Для каждого пользователя надо хранить не менее 336 строк в базе данных, содержащих информацию об недавно прослушанных треках.

Кроме того, нужно учесть лайки и дизлайки пользователя для конкретных треков. Если взять коэффициент вовлечённости в 5% и посчитать количество оценённых треков за год, то получится:

$$
  \frac{52 * 20.7 * 60}{3.69} * 0.05 = 875
$$

Итого, получаем необходимость хранить для каждого пользователя не менее 1211. При среднем размере одной строки в 32 байта, получаем объём в 38 Кб

### 2.1.4 Среднее количество действий пользователя

Оформим различные действия в виде сводной таблицы:

| Действие                    | Среднее количество действий | Пиковое количество действий |
| :-------------------------- | :-------------------------: | --------------------------: |
| Загрузка главной страницы   |              2              |                           5 |
| Загрузка информации о треке |             48              |                         120 |
| Проставление оценки         |              2              |                           5 |
| Поиск трека                 |              1              |                           3 |
| Всего                       |             53              |                         133 |



## 2.2 Технические метрики
### 2.2.1 Размер хранения

Из источника [[5](#список-источников)] можно получить информацию, что у аналогичной платформы (Яндекс Музыка) размер каталога не менее 75 млн треков. Из источников [[6](#список-источников)] и [[7](#список-источников)] можно получить информацию о распределении битрейта у разных треков. Стоит учитывать, что у некоторых треков имеется сразу несколько битрейтов (например FLAC и MP3).

Учитывая распределение, произведём подсчёт размера хранилища, необходимого для хранения всего каталога музыки (среднее время трека 4 минуты):

$$
  T = 4 * 60 * 75000000 \\
  0.27 * 1400 * T + 0.95 * 240 * T + 0.02 * 320 * T + 0.016 * 128 * T  + 0.014 * 192 * T \approx 1389\ Тб
$$

Также посчитаем размер метаданных, которые необходимо хранить (в среднем не более 300 байт на трек):

$$
  300 * 75000000 \approx 21 \ Гб
$$

Итого, получаем таблицу:

|                         | Размер, Шт | Размер, Тб |
| :---------------------- | :--------: | :--------: |
| Треки                   |  75000000  |    1389    |
| Метаданные              |  75000000  |   0.0021   |
| Статические медиафайлы  |  75000000  |    179     |
| Пользовательские данные |  30000000  |    1.06    |

### 2.2.2 Сетевой трафик

Для расчёта сетевого трафика, необходимо подсчитать размер данный, которые будут передаваться за секунду. Будем считать, что битрейт каждого трека равен 240, тогда:

$$
  Q = \frac{20.7}{7} * 3600 * 240 \\
   ⠀\\
  \frac{DAU * Q}{86400} = \frac{5.7 * 10^6 * 2554971.43}{86400} \approx 157 \ Гбит/с
$$

Для расчёта пикового потребления возьмём пиковый коэффициент равный 2.5:

$$
  157 * 2.5 = 392.5 \ Гбит/с
$$

| Стандартная нагрузка, Гбит/с | Пиковая нагрузка, Гбит/с | Суточный, Гб |
| :--------------------------- | :----------------------: | -----------: |
| 157                          |          392.5           |      1814400 |

### 2.2.3 RPC

Таблица количества запросов на основные действия:

| Действие                  | Количество запросов |                                                                  Примечание |
| :------------------------ | :-----------------: | --------------------------------------------------------------------------: |
| Загрузка трека            |          3          | Необходимо получить метаданные трека (векторный поиск) + обложку + сам трек |
| Загрузка главной страницы |          2          |                          Информация о пользователе + плейлисты пользователя |
| Проставление оценки       |          1          |                                          Внести информацию о лайке/дизлайке |
| Поиск трека               |          4          |                      Список треков + список альбомов + метаданные + обложки |

На основе этих данных считаем стандартный и пиковый RPC

$$
  RPC = \frac{5.7 * 10^6 * (3 * 48 + 2 * 2 + 1 * 2 + 4)}{24 * 3600} \approx 10160
$$

| Действие                  | Запросы в день |  RPC  | RPC peak |
| :------------------------ | :------------: | :---: | -------: |
| Загрузка трека            |   820.8 млн    | 9500  |    19000 |
| Загрузка главной страницы |    22.8 млн    |  264  |      528 |
| Проставление оценки       |    11.4 млн    |  132  |      264 |
| Поиск трека               |    22.8 млн    |  264  |      528 |
| Всего                     |     900.6      | 10160 |    25400 |

## 2.3 Список источников
1. [Финансовый отчёт Яндекс за 4 квартал 2025](https://yastatic.net/s3/ir-docs/docs/2025/q4/fc756ee95baa6fa171ee77ac733d52be/%D0%98%D0%BD%D1%84%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%BA%D0%B0_4_%D0%BA%D0%B2_2025.png)
2. [Исследование месячной и дневной аудитории сервисов в РФ](https://mediascope.net/data/)
3. [Среднее время прослушивание музыки пользователями стриминговых сервисов](https://www.ifpi.org/ifpis-global-study-finds-were-listening-to-more-music-in-more-ways-than-ever/#:~:text=11th%20December%202023-,IFPI's%20global%20study%20finds%20we're%20listening%20to%20more,in%20more%20ways%20than%20ever&text=11th%20December%202023%20%E2%80%93%20IFPI%2C%20representing,songs%20per%20week%20in%202023.)
4. [Средняя длина трека](https://www.statsignificant.com/p/whats-the-perfect-song-length-a-statistical)
5. [Размер каталога треков Яндекс музыки](https://www.rbc.ru/technology_and_media/02/11/2024/67259ef99a79472b3a87096a)
6. [Используемый битрейт в Яндекс музыке](https://yandexmusic.userecho.ru/communities/45/topics/2594-informatsiya-ryadom-s-trekom-ves-format-bitrejt)
7. [Исследование используемых битрейтов в Яндекс музыке](https://habr.com/ru/articles/837700/)

# 3 Глобальная балансировка нагрузки

## 3.1 Функционально разбиение нагрузки

### 3.1.1 Действий на запросы

| Действие                  |                     Запрос                     |               Описание запроса                |                                                            Ограничения / особенности |
| :------------------------ | :--------------------------------------------: | :-------------------------------------------: | -----------------------------------------------------------------------------------: |
| Загрузка трека            |     Получение метаданных (векторный поиск)     | Векторный поиск по предпочтениям пользователя | Допустимо использование несколько устаревшей информации о предпочтениях пользователя |
|                           |               Получение обложки                |       Запрос к отдельному S3 хранилищу        |                                                                                      |
|                           |                Получение трека                 |    Длительный TCP запрос к медиахранилищу     |                    В рамках установившегося соединения нельзя изменить битрейт трека |
| Загрузка главной страницы |      Получение информации о пользователе       |            Запрос на чтение из бд             |                                  Данные должны быть синхронизированы между серверами |
|                           | Получение информации о плейлистах пользователя |            Запрос на чтение из бд             |                                  Данные должны быть синхронизированы между серверами |
| Проставление оценки       |           Проставление оценки треку            |                  Запись в бд                  |                                         Допустима временная несогласованность данных |
| Поиск трека               |            Поиск треков по названию            |                  Поиск в бд                   |                                                                                      |
|                           |           Поиск альбомов по названию           |                  Поиск в бд                   |                                                                                      |
|                           |              Загрузка метаданных               |            Запрос на чтение из бд             |                                                                                      |
|                           |                Загрузка обложек                |            Запрос к отдельному S3             |                                                                                      |

### 3.1.2 Разбиение по доменам

| Запрос                                 |              Домен |
| :------------------------------------- | -----------------: |
| Получение метаданных (векторный поиск) |    api.hsemusic.ru |
| Получение обложки                      |     s3.hsemusic.ru |
| Получение трека                        | origin.hsemusic.ru |
| Получение информации о пользователе    |    api.hsemusic.ru |
| Проставление оценки треку              |    api.hsemusic.ru |
| Поиск треков по названию               |    api.hsemusic.ru |
| Поиск альбомов по названию             |    api.hsemusic.ru |


## 3.2 Расположение ДЦ

Решено использовать два датацентра: 1 в **Москве** и 1 в **Красноярске**

Причина использования двух датацентров является необходимость минимизировать задержку, для пользователей из восточной части России, т.к. потенциальная задержка между, например, Москвой и Владивостоком может составлять не менее 80-100 мс, что негативно скажется на пользовательском опыте. Кроме того, использование двух датацентров повысит отказоустойчивость системы.

## Распределение запросов по датацентрам

| Запрос                              |  RPS  | RPS peak |       Сервер |
| :---------------------------------- | :---: | :------: | -----------: |
| Получение метаданных                | 2587  |   6468   |    msk-1-api |
|                                     |  647  |   1618   |    kja-1-api |
| Получение обложки                   | 2587  |   6468   |     msk-1-s3 |
|                                     |  647  |   1618   |    kja-1-api |
| Получение трека                     | 2534  |   6335   | msk-1-origin |
|                                     |  634  |   1585   | kja-1-origin |
| Получение информации о пользователе |  106  |   265    |    msk-1-api |
|                                     |  27   |    68    |    kja-1-api |
| Проставление оценки треку           |  106  |   265    |    msk-1-api |
|                                     |  27   |    68    |    kja-1-api |
| Поиск треков по названию            |  53   |   133    |    msk-1-api |
|                                     |  14   |    35    |    kja-1-api |
| Поиск альбомов по названию          |  53   |   133    |    msk-1-api |
|                                     |  14   |    35    |    kja-1-api |

## Схема DNS балансировки



## Схеиа Anycast балансироки



## Механизм регулировки трафика между датацентрами

От регистрации своей AS решено отказаться. AS Path Prepending будет использоваться при возможности его оперативного изменения хостинг-провайдером, при возникающих перегрузках или отказов.